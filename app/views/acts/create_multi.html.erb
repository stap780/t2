<%= turbo_frame_tag "create_multi", target: "_top" do %>
  <%= form_with url: update_multi_acts_path, method: :put, local: true, data: { controller: "acts" } do |f| %>
    <div class="max-w-7xl mx-auto">
      <h1 class="text-2xl font-semibold mb-4"><%= t('.heading') %></h1>
      
      <% if @incases_group_by_company_id.present? %>
        <!-- Таблица с компаниями и позициями -->
        <% @incases_group_by_company_id.each do |company_id, incases| %>
          
          <% company = incases.first.company %>
          <% metadata = @companies_metadata[company_id] %>
          
          <div class="bg-white rounded-lg shadow mb-4">
          <!-- Заголовок компании с метаданными (цветовой статус уже вычислен на сервере) -->
          <details class="group" data-company-id="<%= company.id %>">
            <summary class="p-4 border-b <%= metadata[:status_css] %> cursor-pointer hover:bg-gray-50 transition-colors list-none">
              <div class="flex items-center justify-between gap-4 flex-wrap">
                <div class="flex items-center space-x-4 flex-1 min-w-0">
                  <%= check_box_tag "act_datas[#{company.id}][id]", '1', false, { 
                    class: 'company-checkbox flex-shrink-0',
                    data: { 
                      action: 'change->acts#toggleCompany',
                      company_id: company.id
                    },
                    onclick: "event.stopPropagation()"
                  } %>
                  <div class="flex-1 min-w-0">
                    <h3 class="font-semibold text-gray-900 truncate"><%= company.short_title %></h3>
                    <span class="text-sm text-gray-600">Округ: <%= company.okrug&.title %></span>
                  </div>
                </div>
                <div class="flex items-center space-x-3 flex-wrap gap-2">
                  <div class="flex items-center space-x-3 text-sm text-gray-600 flex-wrap">
                    <span>К-во дет: <strong class="text-gray-900"><%= metadata[:items_quantity] %></strong></span>
                    <span>Долг: <strong class="text-gray-900"><%= metadata[:items_dolg] %></strong></span>
                    <span>Посл. визит: <strong class="text-gray-900"><%= metadata[:last_day] %></strong></span>
                    <% if metadata[:plandate].present? %>
                      <span>План: <strong class="text-gray-900"><%= metadata[:plandate] %></strong></span>
                    <% end %>
                  </div>
                  <%= select_tag "act_datas[#{company.id}][driver_id]",
                      options_from_collection_for_select(User.drivers, :id, :email_address),
                      {
                        include_blank: "Не назначать водителя",
                        class: "px-3 py-1.5 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-violet-500 focus:border-violet-500 bg-white min-w-[180px]",
                        onclick: "event.stopPropagation()"
                      } %>
                  <svg class="w-5 h-5 text-gray-500 transform transition-transform group-open:rotate-180 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                  </svg>
                </div>
              </div>
            </summary>
            
            <!-- Заявки и позиции компании -->
            <div class="p-4">
              <% incases.each do |incase| %>
                <div class="mb-4 pb-4 border-b border-gray-100 last:border-b-0 last:pb-0">
                  <label class="flex items-center space-x-2 font-medium mb-3 cursor-pointer hover:text-violet-600 transition-colors">
                    <%= check_box_tag "act_datas[#{company.id}][incases][#{incase.id}][selected]", '1', false, { 
                      class: 'incase-checkbox',
                      data: { 
                        action: 'change->acts#toggleIncase',
                        incase_id: incase.id,
                        company_id: company.id,
                        'incase-checkbox': true
                      }
                    } %>
                    <span class="text-gray-900"><%= t('incases.show.title') %> #<%= incase.id %> (<%= incase.unumber %>)</span>
                    <% if incase.incase_status.present? %>
                      <span class="text-sm text-gray-500">- <%= incase.incase_status.title %></span>
                    <% end %>
                  </label>
                  
                  <%= hidden_field_tag "act_datas[#{company.id}][incases][#{incase.id}][id]", incase.id %>
                  
                  <div class="ml-6 space-y-2">
                    <% incase.items.select { |item| @item_status_ids.include?(item.item_status_id.to_s) }.each do |item| %>
                      <%= hidden_field_tag "act_datas[#{company.id}][incases][#{incase.id}][items][#{item.id}][id]", item.id %>
                      <label class="flex items-center space-x-2 hover:bg-gray-50 rounded px-2 -mx-2 cursor-pointer group">
                        <%= check_box_tag "act_datas[#{company.id}][incases][#{incase.id}][items][#{item.id}][selected]", '1', false, { 
                          class: 'item-checkbox mt-0.5 flex-shrink-0',
                          data: { 
                            'item-checkbox': true,
                            incase_id: incase.id,
                            company_id: company.id
                          }
                        } %>
                        <div class="flex-1 min-w-0">
                          <span class="text-gray-900 text-sm"><%= item.title %> (<%= item.katnumber %>)</span>
                          <span class="text-sm text-gray-500 ml-2">
                            - <%= item.item_status&.title || 'Без статуса' %>
                            (<%= item.updated_at.strftime('%d/%m/%Y') %>)
                          </span>
                        </div>
                      </label>
                    <% end %>
                  </div>
                </div>
              <% end %>
            </div>
          </details>
          </div>

        <% end %>
        
        <div class="flex justify-end space-x-3 mt-6">
          <%= f.submit t('actions.create'), class: "px-4 py-2 bg-violet-600 text-white rounded-md hover:bg-violet-700" %>
          <%= link_to t('actions.cancel'), acts_path, class: "px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300" %>
        </div>
      <% else %>
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
          <p class="text-yellow-800">Не найдено заявок с позициями для выбранных округов и статусов.</p>
        </div>
        <div class="flex justify-end space-x-3 mt-6">
          <%= link_to t('actions.back'), new_act_path, class: "px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300", data: { turbo_prefetch: false } %>
        </div>
      <% end %>
    </div>
  <% end %>
<% end %>