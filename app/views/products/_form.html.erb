<!-- Скрытая форма для массового удаления -->
<%= form_with url: delete_images_path, data: {turbo_stream: true, turbo_method: :post, turbo_confirm: "Are you sure?"}, id: :bulk_images_form do |f| %>
  <%= f.submit "delete imgs", class: "hidden", id: 'delete-imgs'%>
<% end %>
<!-- Скрытая форма для массового удаления -->
<%= turbo_frame_tag dom_id(product) do %>
  <%= form_with model: product, local: true do |f| %>
    <%= render "shared/errors", object: product if product.errors.any? %>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Большая часть - основная информация -->
      <div class="lg:col-span-2 space-y-6">
        <div class="bg-white rounded-lg shadow p-6">
          
          <%= turbo_frame_tag dom_id(product, :title), class: "mb-4", data: { controller: "character-counter" } do %>
            <%=tag.div class: "flex items-center justify-between gap-1 mb-1" do %>
              <%= f.label :title, class: "block text-sm font-medium text-gray-700" %>
              <%=tag.span class: "text-sm text-gray-500", data: { character_counter_target: "counter" }%>
            <% end %>
            <%= f.text_field :title, class: "w-full px-3 py-2 border border-gray-300 rounded-md", data: { character_counter_target: "input" }, maxlength: "50" %>
          <% end %>

          <%= turbo_frame_tag dom_id(product, :description), class: "mb-4" do %>
            <%= f.label :description, class: "block text-sm font-medium text-gray-700 mb-1" %>
            <%= f.rich_text_area :description, class: "w-full px-3 py-2 border border-gray-300 rounded-md min-h-[200px]" %>
          <% end %>
        </div>

        <!-- Variants -->
        <div class="bg-white rounded-lg shadow p-4">
          
          <% if product.new_record? %>
            <div class="mb-3">
              <%= f.fields_for :variants, Variant.new do |variant| %>
                <%= render 'variants/form_data', f: variant %>
              <% end %>
            </div>
          <% else %>
            <div class="flex items-center justify-between mb-3">
              <%= tag.label t("products.form.variants"), class: "text-sm font-medium text-gray-700" %>
              <%# link_to t("products.form.add_variant"), new_product_variant_path(product), 
                  class: "inline-flex items-center px-3 py-1 bg-blue-600 text-white rounded-md hover:bg-blue-700",
                  data: { turbo_frame: 'offcanvas', turbo_prefetch: false } %>
            </div>
                
            <%= turbo_stream_from product, :variants %>
            
            <%= turbo_frame_tag product, :variants, class: "w-full" do %>
              <div class="grid grid-cols-[50px_200px_1fr_140px_140px_125px] gap-2 py-2 border-t hover:bg-gray-50">
                <div>#</div>
                <div><%# t("products.form.sku") %></div>
                <div><%= t("products.form.quantity") %></div>
                <div><%= t("products.form.cost_price") %></div>
                <div><%= t("products.form.price") %></div>
                <div></div>
              </div>

              <% product.variants.each do |variant| %>
                <%= render partial: "variants/variant", locals: { variant: variant, product: product } %>
              <% end %>
            <% end %>
          <% end %>
        </div>

        <!-- Features -->
        <div class="bg-white rounded-lg shadow p-6">
        <div class="mb-2 flex items-center justify-between">
          <legend class="text-sm font-medium text-gray-700"><%= t("features.title") %></legend>
          <% path = product.new_record? ? new_feature_path(product_id: nil) : new_product_feature_path(product) %>
          <%= link_to t("features.add_feature"), path, data: { turbo_stream: "true" },
            class: "px-3 py-1 rounded-md bg-blue-300 hover:bg-blue-400" %>
        </div>      
          <%= turbo_frame_tag dom_id(product, 'features') do %>
            <div class="grid grid-cols-[1fr_1fr_50px] gap-4 p-2 hover:bg-gray-50">
              <div>Название</div>
              <div>Значение</div>
              <div></div>
            </div>

            <% product.features.order(:property_id).each do |feature| %>  
              <%= render "features/feature", feature: feature, product: product %>
            <% end %>
          <% end %>
        </div>
      </div>

      <!-- Маленькая часть - статус, тип и картинки -->
      <div class="lg:col-span-1 space-y-6">
        <div class="bg-white rounded-lg shadow p-6">
          <div class="flex gap-2 items-end">
            <div class="flex-1">
              <%= f.select :status, 
                  options_for_select(Product::STATUS.map { |s| [t("products.form.status.#{s}"), s] }, product.status),
                  { include_blank: t("products.form.select_status") },
                  { class: "w-full px-3 py-2 border border-gray-300 rounded-md" } %>
            </div>
            <div class="flex-1">
              <%= f.select :tip, 
                  options_for_select(Product::TIP.map { |t| [t("products.form.tip.#{t}"), t] }, product.tip),
                  { include_blank: t("products.form.select_type") },
                  { class: "w-full px-3 py-2 border border-gray-300 rounded-md" } %>
            </div>
          </div>
        </div>

        <!-- Images -->
        <div class="bg-white rounded-lg shadow px-4 py-4" data-controller="image" data-image-product-id-value="<%= product.persisted? ? product.id : 0 %>">
          <%= turbo_stream_from "images" %>
          
          <!-- Поле для загрузки & Кнопка массового удаления-->
          <div class="flex justify-between mb-4">
            <label for="delete-imgs" class="inline-flex items-center px-3 py-1 border border-violet-500 text-violet-600 bg-white hover:bg-violet-50 hover:text-violet-700 rounded-md cursor-pointer transition">
              <svg class="w-5 h-5 text-violet-600" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6M1 7h22M7 7V5a2 2 0 012-2h2a2 2 0 012 2v2" />
              </svg>
              <span class="ml-2">Все изобр</span>
            </label>
            <input type="file" 
                  id="product-images-upload"
                  multiple="multiple" 
                  data-direct-upload-url="<%= rails_direct_uploads_url %>" 
                  data-action="change->image#uploadFile" 
                  data-image-target="filesInput" 
                  accept='image/*'
                  class="hidden" />
            <button type="button" 
                    class="inline-flex items-center gap-2 px-3 py-1 bg-gradient-to-r from-violet-500 to-violet-600 hover:from-violet-600 hover:to-violet-700 text-white text-sm font-medium rounded-lg cursor-pointer transition-all duration-200 shadow-md hover:shadow-lg transform hover:scale-105"
                    data-action="click->image#triggerFileInput">
              <span>Загрузить</span>
            </button>
          </div>

          <!-- Список изображений -->
          <%= turbo_frame_tag "images", class: "flex flex-wrap gap-1", data: { controller: "sortable" } do %>
            <%= f.fields_for :images do |form| %>
              <%= render partial: "images/image", 
                  locals: { 
                    blob: form.object.file, 
                    image_id: form.object.id, 
                    image_position: form.object.position, 
                    product_id: product.id, 
                    f: form 
                  } if form.object.file.attached? %>
            <% end %>
          <% end %>

        </div>
        
      </div>
    </div>

    <!-- Кнопки действий -->
    <div class="mt-6 flex justify-start space-x-3">
      <%= f.submit class: "px-4 py-2 bg-violet-600 text-white rounded-md hover:bg-violet-700", data: { turbo: false } %>
      <%= link_to t("products.form.cancel"), products_path, class: "px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300", data: { turbo: false } %>
    </div>
  <% end %>
<% end %>