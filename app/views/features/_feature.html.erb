<% 
  featureable = local_assigns[:featureable] || local_assigns[:product] || local_assigns[:detal]
  featureable_type = featureable.class.name.downcase
  featureable_param = "#{featureable_type}_id"
%>
<%= turbo_frame_tag "feature_#{turbo_id_for(feature)}" do %>
  <%= fields_for "#{featureable_type}[features_attributes][#{turbo_id_for(feature)}]", feature do |ff| %>
    <div class="grid grid-cols-[1fr_1fr_60px] gap-2 p-1 border-t hover:bg-gray-50" id="feature_<%= turbo_id_for(feature) %>">
      <%= ff.collection_select :property_id, Property.all.order(title: :asc), :id, :title, { prompt: t("features.select_property"), selected: feature.property_id }, 
      { class: "flex-1 px-2 py-1 border rounded-md",
        data: {
          controller: "slimselect",
          search_url: search_properties_path,
          nested_url: characteristics_properties_path,
          turbo_frame: "feature_#{turbo_id_for(feature)}",
          turbo_frame_characteristic: "characteristic_#{turbo_id_for(feature)}",
          "#{featureable_param}": (featureable.persisted? ? featureable.id : nil)
        } } %>
      
      <%= turbo_frame_tag "characteristic_#{turbo_id_for(feature)}" do %>
        <%= ff.collection_select :characteristic_id, 
            (feature.property&.characteristics || []), :id, :title, 
            { prompt: t("features.select_characteristic"), selected: feature.characteristic_id }, 
            { 
              class: "flex-1 px-2 py-1 border rounded-md",
              id: "feature_#{turbo_id_for(feature)}_characteristic_id",
              data: {
                controller: "slimselect",
                search_url: search_characteristics_path,
                property_id: feature.property_id
              }
            } %>
      <% end %>
      
      <%= ff.hidden_field :id %>
      <% 
        if featureable.is_a?(Product)
          path = featureable.new_record? ? feature_path(id: turbo_id_for(feature)) : product_feature_path(featureable, turbo_id_for(feature))
        elsif featureable.is_a?(Detal)
          path = featureable.new_record? ? feature_path(id: turbo_id_for(feature)) : detal_feature_path(featureable, turbo_id_for(feature))
        else
          path = feature_path(id: turbo_id_for(feature))
        end
      %>
      <div class="flex justify-end items-center space-x-1">
        <%= link_to new_property_characteristic_path(feature.property), data: { turbo_frame: :offcanvas }, class: "text-blue-600 hover:text-blue-800 inline-flex items-center" do %>
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 20 20" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 5v10m5-5H5" />
          </svg>
        <% end if feature.property_id.present?  %>

        <%= link_to_delete path, data: { turbo_method: :delete, turbo_confirm: "Are you sure?" } %>
      </div>
    </div>
  <% end %>
<% end %>