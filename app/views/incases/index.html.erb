<div class="flex items-center justify-between mb-4">
  <h1 class="text-xl font-semibold"><%= t(".heading") %> <small class="text-sm text-gray-500"><%= @incases.count %></small></h1>

  <div class="flex space-x-2 items-center">    
    <%= form_with url: incases_path, method: :post, id: :bulk_action_form, local: false do |f| %>
      <div class="relative inline-block" data-controller="dropdown">
        <button type="button" 
                class="inline-flex items-center px-3 py-1 bg-green-600 text-white rounded-md hover:bg-green-700"
                data-action="click->dropdown#toggle">
          <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
          Экспорт C
          <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
          </svg>
        </button>
        <div class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-1" data-dropdown-target="menu">
          <div class="py-1">
            <%= f.button 'Общий', type: :submit, 
                class: "block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100", 
                formaction: polymorphic_path(Incase.new, action: 'download', download_type: :filtered, download_kind: :mono) %>
            <%= f.button 'Детально', type: :submit, 
                class: "block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100", 
                formaction: polymorphic_path(Incase.new, action: 'download', download_type: :filtered) %>
          </div>
        </div>
      </div>      
      <%= render 'shared/download_excel_buttons', f: f, object: Incase.new %>
      <%= render 'shared/bulk_delete_buttons', f: f, object: Incase.new %>
      <%= render 'send_incase' %>
    <% end %>
    
    <%# link_to t('.filter'), filter_incases_path, class: "inline-flex items-center px-3 py-1 bg-blue-600 text-white rounded-md hover:bg-blue-700", data: { turbo_frame: 'offcanvas' } %>
    <%= link_to t('.new'), new_incase_path, class: "inline-flex items-center px-3 py-1 bg-violet-600 text-white rounded-md hover:bg-violet-700" %>
  </div>
</div>

<%= search_form_for @search, url: incases_path, method: :get, html: { class: "flex items-center space-x-2 flex-wrap  mb-4" } do |f| %>
  <%= f.search_field :unumber_or_items_barcode_or_carnumber_cont, value: params.dig(:q, :unumber_or_items_barcode_or_carnumber_cont), placeholder: t('.incases_search'), class: "h-8 px-2 py-1 border border-gray-300 rounded mb-3 ", style: "min-width: 400px;" %>
  <%= f.search_field :company_title_cont, value: params.dig(:q, :company_title_cont), placeholder: t('activerecord.attributes.incase.company_id'), 
  class: "h-8 px-2 py-1 mb-3 border border-gray-300 rounded-md"%>
  <% selected_status_ids = Array(params.dig(:q, :incase_status_id_in)).reject(&:blank?).map(&:to_s) %>
  <div class="relative mb-3" data-controller="multiselect-dropdown" data-action="change->multiselect-dropdown#updateButtonLabel">
    <button type="button" data-multiselect-dropdown-target="button" data-placeholder="<%= t('activerecord.attributes.incase.incase_status_id') %>" data-action="click->multiselect-dropdown#toggle"
            class="w-full h-8 px-2 py-1 text-left border border-gray-300 rounded-md flex items-center justify-between", style="min-width: 180px;" >
      <span data-multiselect-dropdown-target="label"><%= selected_status_ids.size == 0 ? t('activerecord.attributes.incase.incase_status_id') : "#{selected_status_ids.size} выбрано" %></span>
      <svg class="w-4 h-4 text-gray-500 shrink-0 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
    </button>
    <div data-multiselect-dropdown-target="panel" class="hidden absolute top-full left-0 mt-1 w-full max-h-120 overflow-auto bg-white border border-gray-300 rounded-md shadow-lg z-10 py-1">
      <% IncaseStatus.all.reverse_each do |status| %>
        <label class="flex items-center gap-1 px-1 py-1 hover:bg-gray-50 cursor-pointer text-sm">
          <%= check_box_tag "q[incase_status_id_in][]", status.id, selected_status_ids.include?(status.id.to_s), class: "rounded border-gray-300 text-violet-600 focus:ring-violet-500" %>
          <%= status.title %>
        </label>
      <% end %>
    </div>
  </div>
  <% selected_tip_ids = Array(params.dig(:q, :incase_tip_id_in)).reject(&:blank?).map(&:to_s) %>
  <div class="relative mb-3" data-controller="multiselect-dropdown" data-action="change->multiselect-dropdown#updateButtonLabel">
    <button type="button" data-multiselect-dropdown-target="button" data-placeholder="<%= t('activerecord.attributes.incase.incase_tip_id') %>" data-action="click->multiselect-dropdown#toggle"
            class="w-full h-8 px-2 py-1 text-left border border-gray-300 rounded-md flex items-center justify-between", style="min-width: 180px;" >
      <span data-multiselect-dropdown-target="label"><%= selected_tip_ids.size == 0 ? t('activerecord.attributes.incase.incase_tip_id') : "#{selected_tip_ids.size} выбрано" %></span>
      <svg class="w-4 h-4 text-gray-500 shrink-0 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
    </button>
    <div data-multiselect-dropdown-target="panel" class="hidden absolute top-full left-0 mt-1 w-full max-h-80 overflow-auto bg-white border border-gray-300 rounded-md shadow-lg z-10 py-1">
      <% IncaseTip.all.each do |tip| %>
        <label class="flex items-center gap-1 px-1 py-1 hover:bg-gray-50 cursor-pointer text-sm">
          <%= check_box_tag "q[incase_tip_id_in][]", tip.id, selected_tip_ids.include?(tip.id.to_s), class: "rounded border-gray-300 text-violet-600 focus:ring-violet-500" %>
          <%= tip.title %>
        </label>
      <% end %>
    </div>
  </div>
  <%= f.collection_select :strah_id_eq, Company.strah.limit(20), :id, :short_title, 
      { include_blank: false, prompt: t('activerecord.attributes.incase.strah_id') }, 
      { class: "h-8 px-2 py-1 mb-3 border border-gray-300 rounded-md", style: "max-width: 200px;" } %>
  <div>
    <%= f.label :date_gteq, "Дата от", class: "block text-sm font-medium text-gray-700 mb-1" %>
    <%= f.date_field :date_gteq, class: "h-8 px-2 py-1 mb-4 border border-gray-300 rounded-md" %>
  </div>
  <div>
    <%= f.label :date_lteq, "Дата до", class: "block text-sm font-medium text-gray-700 mb-1" %>
    <%= f.date_field :date_lteq, class: "h-8 px-2 py-1 mb-4 border border-gray-300 rounded-md" %>
  </div>
  <div class="mb-4" data-controller="checkbox">
    <div class="block text-sm font-medium text-gray-700 mb-1">Сумма</div>
    <div class="flex flex-wrap gap-4 h-8">
      <div class="flex items-center space-x-2">
        <%= check_box_tag "q[totalsum_gteq]", "1", params.dig(:q, :totalsum_gteq).present?, class: "rounded border-gray-300 text-violet-600 focus:ring-violet-500", data: { checkbox_target: "btn", action: "change->checkbox#toggleOne" } %>
        <%= label_tag "q_totalsum_gteq", "Есть", class: "text-sm text-gray-700" %>
      </div>
      <div class="flex items-center space-x-2">
        <%= check_box_tag "q[totalsum_blank_eq]", "true", params.dig(:q, :totalsum_blank_eq).to_s == 'true', class: "rounded border-gray-300 text-violet-600 focus:ring-violet-500", data: { checkbox_target: "btn", action: "change->checkbox#toggleOne" } %>
        <%= label_tag "q_totalsum_blank_eq", "Нет", class: "text-sm text-gray-700" %>
      </div>
    </div>
  </div>
  <%= f.submit t('.search'), class: "h-8 px-2 py-1 bg-gray-200 rounded hover:bg-gray-300 mb-3 mt-5" %>
  <%= link_to incases_path(search_cancel: true), class: "h-8 px-2 py-1 bg-gray-100 rounded hover:bg-gray-200 flex items-center mb-3 mt-5", title: t('.clear') do %>
    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
    </svg>
  <% end %>
<% end %>

<%= turbo_stream_from "incases" %>

<div class="bg-white rounded-lg shadow divide-y" data-controller="selectall">
  <div class="grid grid-cols-[40px_85px_85px_220px_160px_100px_120px_110px_110px_40px_30px] gap-1 px-2 py-4 font-medium text-gray-700">
    <div>
      <%= check_box_tag "select_all", "1", false, {
        class: 'checkboxes w-4 h-4 text-violet-600 border-gray-300 rounded focus:ring-violet-500',
        id: 'select_all_checkbox',
        data: { 
          'selectall_target': 'parentCheckbox',
          action: "change->selectall#toggleAll"
        },
        form: :bulk_action_form
      } %>
    </div>
    <div><%= t('activerecord.attributes.incase.incase_status_id') %></div>
    <div><%= t('activerecord.attributes.incase.incase_tip_id') %></div>
    <div><%= t('incases.index.ubitok') %></div>
    <div><%= t('activerecord.attributes.incase.company_id') %></div>
    <div><%= t('activerecord.attributes.incase.okrug') %></div>
    <div><%= t('activerecord.attributes.incase.auto') %></div>
    <div><%= sort_link(@search, :totalsum, t('activerecord.attributes.incase.totalsum')) %></div>
    <div>
      <%= sort_link(@search, :date, t('activerecord.attributes.incase.date')) %>
    </div>
    <div class="flex items-center justify-center">
      <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" title="<%= t('incases.index.sendstatus') %>">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
      </svg>
    </div>
    <div></div>
  </div>
  <%= turbo_frame_tag "incases" do %>
    <%= render @incases %>
    <%= render "shared/paginate", f: @incases %>
  <% end %>
</div>