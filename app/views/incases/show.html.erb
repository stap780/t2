<div class="max-w-1xl mx-auto">
  <h1 class="text-2xl font-semibold mb-4"><%= t('.heading') %></h1>
  
  <div class="bg-white rounded-lg shadow p-6 mb-6">
    <div class="grid grid-cols-2 gap-4">
      <div>
        <strong><%= t('activerecord.attributes.incase.unumber') %>:</strong>
        <%= @incase.unumber %>
      </div>
      <div>
        <strong><%= t('activerecord.attributes.incase.date') %>:</strong>
        <%= @incase.date&.strftime('%d.%m.%Y') %>
      </div>
      <div>
        <strong><%= t('activerecord.attributes.incase.company_id') %>:</strong>
        <%= @incase.company&.short_title %>
      </div>
      <div>
        <strong><%= t('activerecord.attributes.incase.strah_id') %>:</strong>
        <%= @incase.strah&.short_title %>
      </div>
    </div>
  </div>

  <div class="bg-white rounded-lg shadow p-6">
    <h2 class="text-lg font-semibold mb-4"><%= t('activerecord.models.item.other') %></h2>
    <div class="grid grid-cols-[1fr_100px_100px_100px_100px] gap-4 p-2 border-t hover:bg-gray-50 font-medium text-gray-700">
      <div><%= t('activerecord.attributes.item.title') %></div>
      <div><%= t('activerecord.attributes.item.quantity') %></div>
      <div><%= t('activerecord.attributes.item.price') %></div>
      <div><%= t('activerecord.attributes.item.sum') %></div>
    </div>
    <% @incase.items.each do |item| %>
      <div class="grid grid-cols-[1fr_100px_100px_100px_100px] gap-4 p-2 border-t hover:bg-gray-50">
        <div><%= item.title %></div>
        <div><%= item.quantity %></div>
        <div><%= item.price %></div>
        <div><%= item.sum %></div>
      </div>
    <% end %>
  </div>

  <% if @incase.audits.any? || @incase.associated_audits.any? %>
    <div class="bg-white rounded-lg shadow p-6 mt-6">
      <h2 class="text-lg font-semibold mb-4">История изменений</h2>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Действие</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Атрибут</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Старое значение</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Новое значение</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Время</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Пользователь</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            <% (@incase.audits + @incase.associated_audits).sort_by(&:created_at).reverse.each do |audit| %>
              <% audit.audited_changes.each do |key, value| %>
                <tr class="hover:bg-gray-50">
                  <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                    <%= case audit.action
                        when 'create'
                          'Создание'
                        when 'update'
                          'Обновление'
                        when 'destroy'
                          'Удаление'
                        else
                          audit.action
                        end %>
                  </td>
                  <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                    <%= t("activerecord.attributes.#{audit.auditable_type.underscore}.#{key}", default: key.humanize) %>
                  </td>
                  <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">
                    <%= value.respond_to?('each') ? (value[0].present? ? value[0] : '-') : (value.present? ? value : '-') %>
                  </td>
                  <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                    <%= value.respond_to?('each') ? (value[1].present? ? value[1] : '-') : '-' %>
                  </td>
                  <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">
                    <%= audit.created_at&.strftime('%d.%m.%Y %H:%M') %>
                  </td>
                  <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">
                    <%= audit.user&.email || 'Система' %>
                  </td>
                </tr>
              <% end %>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  <% end %>

  <div class="mt-6">
    <%= link_to t('actions.edit'), edit_incase_path(@incase), class: "px-4 py-2 bg-violet-600 text-white rounded-md hover:bg-violet-700" %>
    <%= link_to t('actions.back'), incases_path, class: "px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 ml-2" %>
  </div>
</div>

