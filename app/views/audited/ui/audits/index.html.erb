<%= render 'shared/offcanvas_inner_left', title: t('.title.all'), width: '65rem' do %>
  <% if defined?(@q) && @q.present? %>
    <%= render "search_form" %>
  <% end %>
  
  <% 
    # Поддержка associated_audits для моделей типа Incase и Product
    # Для Product это включает audits от Variant и Feature
    if @auditable&.respond_to?(:associated_audits)
      associated = @auditable.associated_audits.includes(:user).to_a
      all_audits = (@audits.to_a + associated).sort_by(&:created_at).reverse
    else
      all_audits = @audits.to_a
    end
  %>
  
  <div class="overflow-x-auto mt-4">
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <% if @auditable_type.blank? %>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              <%= t("activerecord.attributes.audit.auditable_type") %>
            </th>
          <% end %>
          <% if @auditable.blank? %>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              <%= t("activerecord.attributes.audit.auditable") %>
            </th>
          <% end %>
          <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
            <%= sort_link @q, :version, t("activerecord.attributes.audit.version") if defined?(@q) && @q.present? %>
            <%= t("activerecord.attributes.audit.version") unless defined?(@q) && @q.present? %>
          </th>
          <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
            <%= sort_link @q, :created_at, t("activerecord.attributes.audit.created_at") if defined?(@q) && @q.present? %>
            <%# t("activerecord.attributes.audit.created_at") unless defined?(@q) && @q.present? %>
            <%# t("activerecord.attributes.audit.action") %>
            <%# t("activerecord.attributes.audit.user") %>
          </th>
          <th colspan="3" class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
            <%= t("activerecord.attributes.audit.audited_changes") %>
          </th>
        </tr>
        <tr>
          <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" colspan="<%= 6 - [@auditable_type, @auditable].compact.size - 2 %>"></th>
          <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"><%= t(".attribute", default: "Атрибут") %></th>
          <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"><%= t(".before", default: "Старое значение") %></th>
          <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"><%= t(".after", default: "Новое значение") %></th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200">
        <% if all_audits.any? %>
          <% all_audits.each do |audit| %>
            <% 
              # Исключаем виртуальные атрибуты для Product
              excluded_attributes = ['images_urls', 'file_description']
              filtered_changes = audit.audited_changes.reject { |attr, _| excluded_attributes.include?(attr.to_s) }
            %>
            <% filtered_changes.each_with_index do |(attribute, change), i| %>
              <tr class="hover:bg-gray-50">
                <% if i.zero? %>
                  <% if @auditable_type.blank? %>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900" rowspan="<%= filtered_changes.size %>">
                      <%= link_to t("activerecord.models.#{audit.auditable_type.underscore.downcase}", count: 1, default: audit.auditable_type), 
                          audited_auditable_type_audits_path(audit.auditable_type.underscore.downcase),
                          class: "text-violet-600 hover:text-violet-800" %>
                    </td>
                  <% end %>
                  <% if @auditable.blank? %>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900" rowspan="<%= filtered_changes.size %>">
                      <%= link_to audit.auditable, 
                          audited_auditable_audits_path(auditable_type: audit.auditable_type.underscore.downcase, auditable_id: audit.auditable_id),
                          class: "text-violet-600 hover:text-violet-800" %>
                    </td>
                  <% end %>
                  <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900" rowspan="<%= filtered_changes.size %>">
                    <%= audit.version %>
                    <% if @auditable&.respond_to?(:associated_audits) && @auditable_type.present? %>
                      <span class="text-gray-500 text-xs">
                        (<%= t("activerecord.models.#{audit.auditable_type.underscore.downcase}", count: 1, default: audit.auditable_type) %>)
                      </span>
                    <% end %>
                  </td>
                  <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500" rowspan="<%= filtered_changes.size %>">
                    <%= audit.created_at&.strftime('%d.%m.%Y %H:%M') %><br>
                    <%= t("activerecord.attributes.audit.action") %>: <%= t(".actions.#{audit.action}") %><br>
                    <%= t("activerecord.attributes.audit.user") %>: <%= audit.user&.email_address || t(".system") %>
                  </td>
                <% end %>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                  <%= t("activerecord.attributes.#{audit.auditable_type.underscore.downcase}.#{attribute}", default: attribute.humanize) %>
                </td>
                <td class="px-4 py-3 text-sm text-gray-500" style="max-width: 400px; word-wrap: break-word;">
                  <% 
                    # Правильно обрабатываем старое значение
                    # В audited gem:
                    # - для create: [nil, value] или [value, value] или просто value
                    # - для update: [old_value, new_value]
                    # - для destroy: value (последнее значение)
                    old_val = if change.is_a?(Array) && change.length >= 2
                      # Если для create действия старое и новое одинаковые, значит это было при создании
                      if audit.action == 'create' && change[0] == change[1]
                        nil
                      else
                        change[0]
                      end
                    elsif audit.action == 'create'
                      nil
                    elsif audit.action == 'destroy'
                      change
                    else
                      nil
                    end
                  %>
                  <%= history_value(attribute, old_val, auditable_type: audit.auditable_type) %>
                </td>
                <td class="px-4 py-3 text-sm text-gray-900" style="max-width: 400px; word-wrap: break-word;">
                  <% 
                    # Правильно обрабатываем новое значение
                    new_val = if change.is_a?(Array) && change.length >= 2
                      change[1]
                    elsif audit.action == 'create'
                      change
                    elsif audit.action == 'destroy'
                      nil
                    else
                      change
                    end
                  %>
                  <%= history_value(attribute, new_val, auditable_type: audit.auditable_type) %>
                </td>
              </tr>
            <% end %>
          <% end %>
        <% else %>
          <tr>
            <td colspan="<%= 9 - [@auditable_type, @auditable].compact.size %>" class="px-4 py-3 text-center text-sm text-gray-500">
              <%= t(".empty", default: "История изменений отсутствует") %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
  
  <% if @audits.respond_to?(:total_pages) && @audits.total_pages > 1 %>
    <div class="mt-4">
      <%= will_paginate @audits, class: "flex justify-center" %>
    </div>
  <% end %>
<% end %>
