<%= form_with model: company, local: true do |f| %>
  <%= render "shared/errors", object: company if company.errors.any? %>

  <!-- Tabs Navigation -->
  <div class="bg-white rounded-lg shadow mb-6 w-full min-w-0" data-controller="tabs">
    <div class="border-b border-gray-200 flex items-center justify-between px-4">
      <nav class="flex -mb-px" aria-label="Tabs">
        <button type="button" 
                data-tabs-target="tab"
                data-action="click->tabs#switch"
                data-tab-name="main"
                class="px-6 py-3 text-sm font-medium text-violet-600 border-b-2 border-violet-600 cursor-pointer">
          Основная информация
        </button>
        <button type="button" 
                data-tabs-target="tab"
                data-action="click->tabs#switch"
                data-tab-name="rekviziti"
                class="px-6 py-3 text-sm font-medium text-gray-500 hover:text-gray-700 border-b-2 border-transparent hover:border-gray-300 cursor-pointer">
          Реквизиты
        </button>
      </nav>
      <% unless company.new_record? %>
        <%= link_to_history(auditable_type: "company", auditable_id: company.id) %>
      <% end %>
    </div>

    <!-- Tab Content -->
    <div class="p-6 w-full min-w-0">
      <!-- Main Tab -->
      <div data-tabs-target="panel" data-tab-name="main" class="tab-panel w-full min-w-0">
        <div class="space-y-6">
          <div class="grid grid-cols-[250px_250px_1fr] gap-4">
            <div>
              <%= f.label :okrug_id, "Округ", class: "block text-sm font-medium text-gray-700 mb-1" %>
              <%= f.collection_select :okrug_id, Okrug.all, :id, :title, { prompt: "Выберите округ" }, { class: "w-full px-3 py-2 h-9 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-violet-500 focus:border-violet-500" } %>
            </div>
            <div>
              <%= f.label :tip, class: "block text-sm font-medium text-gray-700 mb-1" %>
              <%= f.select :tip, Company.tip_collection, { prompt: "Выберите тип" }, { class: "w-full px-3 py-2 h-9 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-violet-500 focus:border-violet-500" } %>
            </div>
            <div>
              <%= f.label :short_title, class: "block text-sm font-medium text-gray-700 mb-1" %>
              <%= f.text_field :short_title, class: "w-full px-3 py-2 h-9 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-violet-500 focus:border-violet-500", required: true %>
            </div>
            <div class="sm:col-span-4">
              <%= f.label :fact_address, class: "block text-sm font-medium text-gray-700 mb-1" %>
              <%= f.text_field :fact_address, class: "w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-violet-500 focus:border-violet-500" %>
            </div>
          </div>

          <div class="flex flex-col gap-2 border-t pt-6">
            <div class="mb-2 flex items-center justify-between">
              <legend class="text-sm font-medium text-gray-700"><%= t("client_companies.title") %></legend>
              <div class="flex gap-2">
                <% path = company.new_record? ? new_client_company_path(company_id: nil) : new_company_client_company_path(company) %>
                <%= link_to t("client_companies.add_client"), path, data: { turbo_stream: "true" },
                  class: "px-3 py-1 rounded-md bg-blue-300 hover:bg-blue-400" %>
                <%= link_to t('clients.new.heading'), new_client_path, class: "inline-flex items-center px-3 py-1 bg-violet-600 text-white rounded-md hover:bg-violet-700", data: { turbo_frame: 'offcanvas', turbo_prefetch: false } %>
              </div>
            </div>      
            <%= turbo_frame_tag "client_companies" do %>
              <% company.client_companies.each do |client_company| %>  
                <%= render "client_companies/client_company", client_company: client_company, company: company %>
              <% end %>
            <% end %>
          </div>

          <div class="flex flex-col gap-2 border-t pt-6">
            <div class="mb-6 pb-6 border-b">
              <h3 class="text-sm font-medium text-gray-700 mb-3">
                <%= t("companies.form.weekdays_title") %>
              </h3>
              <p class="text-sm text-gray-600 mb-4">
                <%= t("companies.form.weekdays_description") %>
              </p>
              <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
                <% Company::WEEKDAYS.each do |day| %>
                  <label class="flex items-center space-x-2 cursor-pointer p-2 rounded-md hover:bg-gray-50">
                    <%= check_box_tag "company[weekdays][]", day, 
                        company.weekday_selected?(day),
                        id: "company_weekdays_#{day}",
                        class: "rounded border-gray-300 text-violet-600 focus:ring-violet-500" %>
                    <span class="text-sm text-gray-700">
                      <%= t("weekdays.#{day}") %>
                    </span>
                  </label>
                <% end %>
                <!-- Hidden field to ensure empty array is sent if nothing is selected -->
                <%= hidden_field_tag "company[weekdays][]", "" %>
              </div>
            </div>
            
            <!-- Plan Dates Section -->
            <%= render "company_plan_dates/company_plan_dates_header", company: company %>
            
            <%= turbo_frame_tag "company_plan_dates" do %>
              <%# if company.company_plan_dates.any? %>
              <%#   = tag.div(class: "grid grid-cols-[200px_1fr_50px] gap-4 p-2 border-t hover:bg-gray-50") do %>
              <%#     = tag.div t("company_plan_dates.date"), class: "font-medium text-gray-700" %>
              <%#     = tag.div t("company_plan_dates.comment"), class: "font-medium text-gray-700" %>
              <%#     = tag.div "" %>
              <%#   end %>
              <%# end %>

              <% company.company_plan_dates.each do |company_plan_date| %>
                <%= render "company_plan_dates/company_plan_date", 
                    company_plan_date: company_plan_date, 
                    company: company %>
              <% end %>
            <% end %>
          </div>

          <div class="border-t pt-6">
            <div>
              <%= f.label :info, class: "block text-sm font-medium text-gray-700 mb-1" %>
              <%= f.text_area :info, rows: 4, class: "w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-violet-500 focus:border-violet-500" %>
            </div>
          </div>

        </div>
      </div>

      <!-- Contacts Tab -->
      <div data-tabs-target="panel" data-tab-name="rekviziti" class="tab-panel hidden">
          <div class="sm:col-span-4">
            <%= f.label :title, class: "block text-sm font-medium text-gray-700 mb-1" %>
            <%= f.text_field :title, class: "w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-violet-500 focus:border-violet-500" %>
          </div>
          <details class="border-t pt-6 group">
            <summary class="cursor-pointer flex items-center justify-between">
              <h3 class="text-lg font-medium text-gray-900">Реквизиты</h3>
              <svg class="w-5 h-5 text-gray-500 transform transition-transform group-open:rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
              </svg>
            </summary>
            <div class="mt-4 grid grid-cols-1 gap-6 sm:grid-cols-2">
              <div>
                <%= f.label :inn, class: "block text-sm font-medium text-gray-700 mb-1" %>
                <%= f.text_field :inn, class: "w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-violet-500 focus:border-violet-500" %>
              </div>
              <div>
                <%= f.label :kpp, class: "block text-sm font-medium text-gray-700 mb-1" %>
                <%= f.text_field :kpp, class: "w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-violet-500 focus:border-violet-500" %>
              </div>
              <div>
                <%= f.label :ogrn, class: "block text-sm font-medium text-gray-700 mb-1" %>
                <%= f.text_field :ogrn, class: "w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-violet-500 focus:border-violet-500" %>
              </div>
              <div>
                <%= f.label :okpo, class: "block text-sm font-medium text-gray-700 mb-1" %>
                <%= f.text_field :okpo, class: "w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-violet-500 focus:border-violet-500" %>
              </div>
              <div class="sm:col-span-2">
                <%= f.label :ur_address, class: "block text-sm font-medium text-gray-700 mb-1" %>
                <%= f.text_field :ur_address, class: "w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-violet-500 focus:border-violet-500" %>
              </div>
            </div>
          </details>

          <details class="border-t pt-6 group">
            <summary class="cursor-pointer flex items-center justify-between">
              <h3 class="text-lg font-medium text-gray-900">Банковские реквизиты</h3>
              <svg class="w-5 h-5 text-gray-500 transform transition-transform group-open:rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
              </svg>
            </summary>
            <div class="mt-4 grid grid-cols-1 gap-6 sm:grid-cols-2">
              <div>
                <%= f.label :bik, class: "block text-sm font-medium text-gray-700 mb-1" %>
                <%= f.text_field :bik, class: "w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-violet-500 focus:border-violet-500" %>
              </div>
              <div>
                <%= f.label :bank_title, class: "block text-sm font-medium text-gray-700 mb-1" %>
                <%= f.text_field :bank_title, class: "w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-violet-500 focus:border-violet-500" %>
              </div>
              <div class="sm:col-span-2">
                <%= f.label :bank_account, class: "block text-sm font-medium text-gray-700 mb-1" %>
                <%= f.text_field :bank_account, class: "w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-violet-500 focus:border-violet-500" %>
              </div>
            </div>
          </details>
      </div>

    </div>
  </div>

  <!-- Кнопки действий -->
  <div class="mt-6 flex justify-start space-x-3">
    <%= f.submit class: "px-4 py-2 bg-violet-600 text-white rounded-md hover:bg-violet-700" %>
    <%= link_to t('actions.cancel'), companies_path, class: "px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300" %>
  </div>
<% end %>

