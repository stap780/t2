namespace :test do
  desc "–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ PDF –¥–ª—è –∞–∫—Ç–∞ (–ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–æ–∂–µ–Ω–∏—è –Ω–∞ —Ñ—É—Ç–µ—Ä)"
  task pdf_generation: :environment do
    puts "=" * 80
    puts "–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ PDF –¥–ª—è –∞–∫—Ç–∞"
    puts "=" * 80
    
    # –ù–∞—Ö–æ–¥–∏–º –∞–∫—Ç —Å –±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –ø–æ–∑–∏—Ü–∏–π –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π
    act = Act.includes(:items, :company, :strah).order(created_at: :desc).first
    
    if act.nil?
      puts "‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω –Ω–∏ –æ–¥–∏–Ω –∞–∫—Ç –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö"
      puts "–°–æ–∑–¥–∞–π—Ç–µ –∞–∫—Ç —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ rails console"
      exit 1
    end
    
    puts "\n–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∞–∫—Ç ##{act.id}"
    puts "–ö–æ–º–ø–∞–Ω–∏—è: #{act.company&.title}"
    puts "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–∑–∏—Ü–∏–π: #{act.items.count}"
    puts "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞—è–≤–æ–∫: #{act.incases.count}"
    
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º PDF
    puts "\n–ì–µ–Ω–µ—Ä–∞—Ü–∏—è PDF..."
    begin
      pdf_data = ActPdfService.new(act).call
      
      if pdf_data.nil?
        puts "‚ùå –û—à–∏–±–∫–∞: PDF –Ω–µ –±—ã–ª —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω"
        exit 1
      end
      
      # –°–æ—Ö—Ä–∞–Ω—è–µ–º PDF –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
      output_path = Rails.root.join("tmp", "test_act_#{act.id}_#{Time.current.to_i}.pdf")
      File.binwrite(output_path, pdf_data)
      
      puts "‚úÖ PDF —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω"
      puts "üìÑ –§–∞–π–ª —Å–æ—Ö—Ä–∞–Ω–µ–Ω: #{output_path}"
      puts "\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–∞–π–ª –≤—Ä—É—á–Ω—É—é, —É–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ:"
      puts "  - –ü–æ–∑–∏—Ü–∏–∏ –Ω–µ –Ω–∞–∫–ª–∞–¥—ã–≤–∞—é—Ç—Å—è –Ω–∞ –ø–æ–¥–ø–∏—Å–∏ –≤ —Ñ—É—Ç–µ—Ä–µ"
      puts "  - –ü—Ä–∏ –Ω–µ—Ö–≤–∞—Ç–∫–µ –º–µ—Å—Ç–∞ —Å–æ–∑–¥–∞—é—Ç—Å—è –Ω–æ–≤—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã"
      puts "  - –§—É—Ç–µ—Ä —Å –ø–æ–¥–ø–∏—Å—è–º–∏ –≤–∏–¥–µ–Ω –Ω–∞ –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö"
      
      # –ü—ã—Ç–∞–µ–º—Å—è –æ—Ç–∫—Ä—ã—Ç—å —Ñ–∞–π–ª (—Ç–æ–ª—å–∫–æ –Ω–∞ macOS)
      if RUBY_PLATFORM.include?('darwin')
        puts "\n–û—Ç–∫—Ä—ã–≤–∞—é PDF..."
        system("open '#{output_path}'")
      end
      
    rescue => e
      puts "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ PDF: #{e.message}"
      puts e.backtrace.first(5).join("\n")
      exit 1
    end
  end
end
