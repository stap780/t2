# Тестирование сценариев отправки писем

## Сценарий 1: Массовая отправка с главной страницы

**Шаги:**
1. Откройте `/incases`
2. Выберите несколько убытков чекбоксами (убедитесь, что у них `sendstatus: nil`)
3. Нажмите кнопку "Отправить письмо"
4. Проверьте результат

**Ожидаемый результат:**
- Убытки группируются по компаниям
- Для каждой компании создается один Excel файл
- Отправляется одно письмо на компанию
- После успешной отправки `sendstatus` обновляется на `true` для всех отправленных убытков
- В таблице появляется иконка email для отправленных убытков

**Проверка:**
- Проверьте таблицу `email_deliveries` - должны быть созданы записи
- Проверьте почту получателей
- Проверьте поле `sendstatus` в таблице `incases`

---

## Сценарий 2: Отправка одного убытка со страницы просмотра

**Шаги:**
1. Откройте `/incases/:id` (страница просмотра убытка)
2. Убедитесь, что у убытка `sendstatus: nil` и нет дубля (`IncaseDubl`)
3. Нажмите кнопку "Отправить письмо"
4. Проверьте результат

**Ожидаемый результат:**
- Создается `EmailDelivery` запись
- Генерируется Excel файл для одного убытка
- Отправляется письмо контрагенту
- После успешной отправки `sendstatus` обновляется на `true`
- На главной странице появляется иконка email для этого убытка

**Проверка:**
- Проверьте таблицу `email_deliveries` - должна быть создана запись с `mailer_method: 'send_excel'`
- Проверьте почту получателя
- Проверьте поле `sendstatus` в таблице `incases`

**Ограничения:**
- Если у убытка есть дубль (`IncaseDubl`) - отправка не происходит, возвращается `false`
- Если у компании нет клиентов с email - `sendstatus` устанавливается в `false`, отправка не происходит

---

## Сценарий 3: Автоматическая отправка через IncaseService (при импорте)

**Шаги:**
1. Создайте файл импорта с новыми убытками (у которых еще нет в системе)
2. Выполните импорт через `/incase_imports/new`
3. Проверьте результат

**Ожидаемый результат:**
- При создании нового убытка (не дубля) автоматически вызывается `IncaseEmailService.send_one(incase.id)`
- Для каждого нового убытка создается `EmailDelivery` запись
- Генерируется Excel файл
- Отправляется письмо контрагенту
- После успешной отправки `sendstatus` обновляется на `true`

**Проверка:**
- Проверьте логи импорта - должны быть записи об отправке писем
- Проверьте таблицу `email_deliveries` - должны быть созданы записи для новых убытков
- Проверьте почту получателей
- Проверьте поле `sendstatus` в таблице `incases` для новых убытков

**Важно:**
- Автоматическая отправка происходит только для новых убытков (не дублей)
- Если отправка не удалась, импорт продолжается (ошибка логируется, но не прерывает процесс)

---

## Общие проверки для всех сценариев

1. **Проверка дублей:**
   - Убытки с дублями (`IncaseDubl`) не должны отправляться
   - Проверка: `IncaseDubl.where(unumber: incase.unumber, stoanumber: incase.stoanumber).exists?`

2. **Проверка email адресов:**
   - Если у компании нет клиентов с email - `sendstatus` устанавливается в `false`
   - Fallback email: `avemik@gmail.com` (или указанный в коде)

3. **Проверка статусов позиций:**
   - В Excel включаются только позиции со статусами "Долг" и "В работе"
   - Проверка: `ItemStatus.where(title: ['Долг', 'В работе'])`

4. **Проверка sendstatus:**
   - `nil` - убыток еще не отправлялся
   - `true` - убыток успешно отправлен
   - `false` - убыток не может быть отправлен (нет email у контрагента)

5. **Проверка EmailDelivery:**
   - Все отправки фиксируются в таблице `email_deliveries`
   - Статусы: `pending`, `sent`, `failed`
   - Можно повторить отправку через `/email_deliveries/:id/retry`

---

## Команды для проверки в консоли Rails

```ruby
# Проверить убытки с разными статусами отправки
Incase.where(sendstatus: nil).count  # Неотправленные
Incase.where(sendstatus: true).count # Отправленные
Incase.where(sendstatus: false).count # Не могут быть отправлены

# Проверить последние EmailDelivery записи
EmailDelivery.where(mailer_class: 'IncaseMailer').order(created_at: :desc).limit(10)

# Проверить убытки с дублями
Incase.all.select { |i| IncaseDubl.where(unumber: i.unumber, stoanumber: i.stoanumber).exists? }

# Проверить компании без клиентов с email
Company.all.select { |c| c.clients.pluck(:email).reject(&:blank?).empty? }
```
